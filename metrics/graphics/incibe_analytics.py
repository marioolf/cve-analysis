import pandas as pd
import matplotlib.pyplot as plt


def read_log_file(file_path):
    with open(file_path, 'r') as file:
        lines = file.readlines()

    data = []
    entry = {}
    current_cve = None
    for line in lines:
        line = line.strip()
        if line:
            if line.startswith("CVE ID:"):
                if entry:
                    data.append(entry)
                    entry = {}
                current_cve = line.split(': ')[1]
                entry['CVE ID'] = current_cve
            elif line.startswith("Resultado de Qualys para CVE"):
                try:
                    result = line.split(': ', 1)[1] 
                    entry['Resultado de Qualys para CVE'] = result
                except IndexError:
                    continue
            elif line.startswith("INCIBE"):
                entry['INCIBE'] = line.split(': ')[1]

            else:
                if current_cve:
                    if 'Description' in entry:
                        entry['Description'] += "\n" + line 
                    else:
                        entry['Description'] = line


    if entry:
        data.append(entry)

    return pd.DataFrame(data)


log_file_path = '../../scrapers_python/latest.log'
df = read_log_file(log_file_path)


incibe_counts = df['INCIBE'].value_counts(normalize=True) * 100


order = ['Pendiente de análisis', 'BAJA', 'MEDIA', 'ALTA', 'CRÍTICA']
color_map = {
    'Pendiente de análisis': '#ffcccc',
    'BAJA': '#ff9999',
    'MEDIA': '#ff6666',
    'ALTA': '#ff3333',
    'CRÍTICA': '#ff0000'
}


incibe_counts = incibe_counts.reindex(order).dropna()

colors = [color_map[cat] for cat in incibe_counts.index]

# gráfico de sectores
plt.figure(figsize=(6, 6))
incibe_counts.plot.pie(autopct='%1.1f%%', startangle=90, colors=colors)
plt.title('Porcentaje de cada tipo de resultado para INCIBE')
plt.ylabel('') 
plt.savefig('incibe_results_pie_chart.png')

